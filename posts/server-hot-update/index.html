<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>从 nginx 热更新聊一聊 Golang 中的热更新 | Yousa Driven Development | YDD</title><meta name=keywords content="nginx,golang"><meta name=description content="从 nginx 热更新聊一聊 Golang 中的热更新

静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？
最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新
热更新是什么？
举个例子，你现在在坐卡车，卡车开到了 150KM/H
然后，有个轮胎，爆了
然后，司机说，你就直接换吧，我不停车。你小心点换
嗯。就这个意思
网关中的热更新
服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。
网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；
有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用

不过实际上线上操作是集群隔离加热更新一起操作
nginx 热更新 (Upgrading Executable on the Fly)
nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。

NginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制
nginx 热升级流程
步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。"><meta name=author content="[厉辉（Yousa）](https://github.com/Miss-you)"><link rel=canonical href=https://miss-you.github.io/posts/server-hot-update/><link crossorigin=anonymous href=/assets/css/stylesheet.90ccfe940c2ebacfe29cf6c094281c8c148bd718511cde00be68d330109118be.css integrity="sha256-kMz+lAwuus/inPbAlCgcjBSL1xhRHN4AvmjTMBCRGL4=" rel="preload stylesheet" as=style><link rel=icon href=https://miss-you.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://miss-you.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://miss-you.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://miss-you.github.io/apple-touch-icon.png><link rel=mask-icon href=https://miss-you.github.io/safari-pinned-tab.svg><meta name=theme-color content="#f4f3ee"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://miss-you.github.io/posts/server-hot-update/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Serif+SC:wght@400;600;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel=stylesheet><meta property="og:url" content="https://miss-you.github.io/posts/server-hot-update/"><meta property="og:site_name" content="Yousa Driven Development | YDD"><meta property="og:title" content="从 nginx 热更新聊一聊 Golang 中的热更新"><meta property="og:description" content="从 nginx 热更新聊一聊 Golang 中的热更新 静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？ 最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新
热更新是什么？ 举个例子，你现在在坐卡车，卡车开到了 150KM/H
然后，有个轮胎，爆了
然后，司机说，你就直接换吧，我不停车。你小心点换
嗯。就这个意思
网关中的热更新 服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。
网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；
有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用
不过实际上线上操作是集群隔离加热更新一起操作
nginx 热更新 (Upgrading Executable on the Fly) nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。
NginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制
nginx 热升级流程 步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-28T01:23:35+08:00"><meta property="article:modified_time" content="2020-12-28T01:32:25+08:00"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="Golang"><meta name=twitter:card content="summary"><meta name=twitter:title content="从 nginx 热更新聊一聊 Golang 中的热更新"><meta name=twitter:description content="从 nginx 热更新聊一聊 Golang 中的热更新

静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？
最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新
热更新是什么？
举个例子，你现在在坐卡车，卡车开到了 150KM/H
然后，有个轮胎，爆了
然后，司机说，你就直接换吧，我不停车。你小心点换
嗯。就这个意思
网关中的热更新
服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。
网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；
有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用

不过实际上线上操作是集群隔离加热更新一起操作
nginx 热更新 (Upgrading Executable on the Fly)
nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。

NginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制
nginx 热升级流程
步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://miss-you.github.io/posts/"},{"@type":"ListItem","position":2,"name":"从 nginx 热更新聊一聊 Golang 中的热更新","item":"https://miss-you.github.io/posts/server-hot-update/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"从 nginx 热更新聊一聊 Golang 中的热更新","name":"从 nginx 热更新聊一聊 Golang 中的热更新","description":"从 nginx 热更新聊一聊 Golang 中的热更新 静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？ 最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新\n热更新是什么？ 举个例子，你现在在坐卡车，卡车开到了 150KM/H\n然后，有个轮胎，爆了\n然后，司机说，你就直接换吧，我不停车。你小心点换\n嗯。就这个意思\n网关中的热更新 服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。\n网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；\n有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用\n不过实际上线上操作是集群隔离加热更新一起操作\nnginx 热更新 (Upgrading Executable on the Fly) nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。\nNginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制\nnginx 热升级流程 步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。\n","keywords":["nginx","golang"],"articleBody":"从 nginx 热更新聊一聊 Golang 中的热更新 静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？ 最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新\n热更新是什么？ 举个例子，你现在在坐卡车，卡车开到了 150KM/H\n然后，有个轮胎，爆了\n然后，司机说，你就直接换吧，我不停车。你小心点换\n嗯。就这个意思\n网关中的热更新 服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。\n网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；\n有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用\n不过实际上线上操作是集群隔离加热更新一起操作\nnginx 热更新 (Upgrading Executable on the Fly) nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。\nNginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制\nnginx 热升级流程 步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。\n1 2 3 4 5 6 7 8 9 UID PID PPID C STIME TTY TIME CMD root 4584 1 0 Oct17 ? 00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx root 12936 4584 0 Oct26 ? 00:03:24 nginx: worker process root 12937 4584 0 Oct26 ? 00:00:04 nginx: worker process root 12938 4584 0 Oct26 ? 00:00:04 nginx: worker process root 23692 4584 0 21:28 ? 00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx root 23693 23692 3 21:28 ? 00:00:00 nginx: worker process root 23694 23692 3 21:28 ? 00:00:00 nginx: worker process root 23695 23692 3 21:28 ? 00:00:00 nginx: worker process 步骤 2、在此之后，所有工作进程（包括旧进程和新进程）将会继续接受请求。这时候，需要发送 WINCH 信号给 nginx master 进程，master 进程将会向 worker 进程发送消息，告知其需要进行 graceful shutdown，worker 进程会在连接处理完之后进行退出。\n1 2 3 4 5 6 7 UID PID PPID C STIME TTY TIME CMD root 4584 1 0 Oct17 ? 00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx root 12936 4584 0 Oct26 ? 00:03:24 nginx: worker process root 12937 4584 0 Oct26 ? 00:00:04 nginx: worker process root 12938 4584 0 Oct26 ? 00:00:04 nginx: worker process root 23692 4584 0 21:28 ? 00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx #若旧的 worker 进程还需要处理连接，则 worker 进程不会立即退出，需要待消息处理完后再退出 步骤 3、经过一段时间之后，将会只会有新的 worker 进程处理新的连接。\n注意，旧 master 进程并不会关闭它的 listen socket；因为如果出问题后，需要回滚，master 进程需要法重新启动它的 worker 进程。\n步骤 4、如果升级成功，则可以向旧 master 进程发送 QUIT 信号，停止老的 master 进程；如果新的 master 进程（意外）退出，那么旧 master 进程将会去掉自己的 pid 文件的。oldbin 后缀。\nnginx 热更新相关信号 master 进程相关信号\n1 2 3 USR2\t升级可执行文件 WINCH\t优雅停止 worker 进程 QUIT\t优雅停止 master 进程 worker 进程相关信号\n1 2 TERM, INT\t快速退出进程 QUIT\t优雅停止进程 nginx 相关代码走读 1、USR2 流程 master 收到 USR2 信号后，会拉起新的 master nginx 进程；\n新的 master 进程拉起新的 worker 进程；\n最终，老的 worker 进程和新的 worker 进程共用一个 listen socket，接受连接\n若打开了 REUSEPORT 开关，则 socket 继承情况会有些区别，感兴趣的可以自行翻看代码\n2、WINCH 流程 master 进程收到 WINCH 信号后，会给各个 worker 进程发送 QUIT 信号，让其优雅退出；master 进程并不再处理新的连接。\nworker graceful shutdown 流程，关闭 listen socket，不再处理新的连接；待已有连接处理完后，清理连接，退出进程。\n3、QUIT 流程 master graceful shutdown 流程，没什么好说的\nnginx 升级过程中若出现问题如何回滚？ nginx 热升级 QA 1、如何防止多次可执行文件触发热更新？\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 相关代码 ngx_signal_handler --\u003e case ngx_signal_value(NGX_CHANGEBIN_SIGNAL): if (ngx_getppid() == ngx_parent || ngx_new_binary \u003e 0) { /* * Ignore the signal in the new binary if its parent is * not changed, i.e. the old binary's process is still * running. Or ignore the signal in the old binary's * process if the new binary's process is already running. */ action = \", ignoring\"; ignore = 1; break; } ngx_change_binary = 1; action = \", changing binary\"; break; 若老的 nginx 还在，nginx 无法进行热更新二进制文件\n2、nginx 升级过程中，发现新的可执行文件出现问题该如何回滚？\na、向旧 master 进程发送 HUP 信号。旧进程将启动新的 worker 进程，而且不会重新读取配置。之后，通过向新的主 master 进程发送 QUIT 信号，可以优雅地关闭新的 master 和 worker 进程。 b、将 TERM 信号发送到新的 master 进程，然后新的 master 进程将向其 worker 进程发送一条消息，让它们立即退出，这种退出不是 graceful shutdown。当新的 master 进程退出时，旧的 master 进程将启动新的 worker 进程。 c、如果新的进程没有退出，则应该向它们发送终止 KILL 信号。当新的 master 进程退出时，旧的 master 进程将启动新的工作进程。 3、什么是 graceful shutdown\n本文中的 graceful shutdown 是指 server 不再处理新的连接，但是进程不会立即退出，待所有连接断开后再退出进程。\n总结一下个人在 nginx 二进制文件热升级时用的命令 1 2 3 4 5 6 7 8 9 10 11 cd /usr/local/nginx cp nginx nginx_bak mv /data/nginx/nginx ./nginx #需要使用 mv 来更新二进制文件 ./nginx -t #尝试启动，查看其加载配置文件等初始化功能是否正常 netstat -anp | grep -E \"80|443\" | grep nginx #检查连接状态 kill -USR2 `cat /usr/local/nginx/nginx.pid` #升级 nginx 可执行文件，此时会有两组 nginx master 和 worker 进程 kill -WINCH `cat /usr/local/nginx/nginx.pid.oldbin` #新的可执行文件启动 ok，且能够正常处理数据流，告知老的 master 进程去通知其 worker 进程进行优雅退出 ... kill -QUIT `cat /usr/local/nginx/nginx.pid.oldbin` #待所有的老的 nginx worker 进程优雅退出后（处理完连接），停止老的 master 进程 TODO：nginx 还会有依赖的 so 文件的热升级–其实更应该属于后台进程的 so 文件热升级流程，我在使用它的时候也踩过坑–主要原因还是操作不规范，对 so 其加载运行原理不够熟悉导致\n热升级 实际上，静态语言后端 server 有一套固定的热升级（单进程）流程，其基本流程如下：\n若需要支持热升级的是多进程，那么 nginx 的热升级过程是最值得参考的\n1、通过调用 fork/exec 启动新的版本的进程，\n2、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket\n3、在此过程中，不会对用户请求造成任何中断。\nnginx 的热升级流程也是类似，只不过由于 nginx 工作是多进程，故它会先启动新版本的一组 master/worker 进程；\n然后停止老的 worker 进程，让其不处理连接，由新的 worker 进程来处理连接；\n升级完毕后，即可退出老的 master 进程，热升级完成。\n热更新 热更新目标：\n1、正在处理中的连接/服务/请求不能立即中断，需要继续提供服务 2、socket 对用户来说要保持可用，可以接受新的请求 直接沿用上篇的思路，热更新（单进程）流程，其基本流程如下：\n1、用新的 bin 文件去替换老的 bin 文件 2、发送信号告知 server 进程（通常是 USR2 信号），进行平滑升级 3、server 进程收到信号后，通过调用 fork/exec 启动新的版本的进程 4、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket 5、老的进程不再接受请求，待正在处理中的请求处理完后，进程自动退出 6、子进程托管给 init 进程 我们可以按照这个思路完成一个简单的可以热更新的 http server\n简易的 http server 首先，我们需要一个最简单的 http server\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func main() { fmt.Println(\"Hello World!\") var err error // 注册 http 请求的处理方法 http.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"Hello world!\")) }) // 在 8086 端口启动 http 服务，其内部有一个循环 accept 8086 端口 // 每当新的 HTTP 请求过来则开一个协程处理 err = http.ListenAndServe(\"localhost:8086\", nil) if err != nil { log.Println(err) } } fork 一个新的进程 在 go 语言里面可以有很多种方法 fork 一个新的进程，但是在这里我更倾向于推荐 exec.Command 接口来启动一个新的进程。因为 Cmd struct 中有一个 ExtraFiles 变量，子进程可以通过它直接继承文件描述符 fd。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func forkProcess() error { var err error files := []*os.File{gListen.File()} //demo only one //.File() path := \"/Users/yousa/work/src/graceful-restart-demo/graceful-restart-demo\" args := []string{ \"-graceful\", } env := append( os.Environ(), \"ENDLESS_CONTINUE=1\", ) env = append(env, fmt.Sprintf(`ENDLESS_SOCKET_ORDER=%s`, \"0,127.0.0.1\")) cmd := exec.Command(path, args...) //cmd := exec.Command(path, \"-graceful\", \"true\") cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr cmd.ExtraFiles = files cmd.Env = env err = cmd.Start() if err != nil { log.Fatalf(\"Restart: Failed to launch, error: %v\", err) return err } return nil } 代码浅析：\n在上面的 files 是存储父进程的文件描述符，path 的内容是新的要替换的可执行文件的路径。\n重要的一点是，.File() 返回一个 dup(2) 的文件描述符。这个重复的文件描述符不会设置 FD_CLOEXEC 标志，这个文件描述符操作容易出错，容易被在子进程中被错误关闭。\n在其他语言（或者 go 里面）里面你可能通过使用命令行将文件描述符传递给子进程，在这里比较推荐使用 ExtraFile 传递 fd。不过 ExtraFiles 在 windows 中不支持。\nargs 中传递的-graceful 参数是告诉子进程这是优雅热升级的一部分，这样子进程可以通过它知道，自己需要重用套接字而不是重新打开一个新的套接字\n子进程初始化 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func main() { fmt.Println(\"Hello World!\") ... var gracefulChild bool var netListen net.Listener var err error args := os.Args ... if len(args) \u003e 1 \u0026\u0026 args[1] == \"-graceful\" { gracefulChild = true } else { gracefulChild = false } fmt.Println(\"gracefulChild:\", gracefulChild) if gracefulChild { //重用套接字 log.Print(\"main: Listening to existing file descriptor 3.\") f := os.NewFile(3, \"\") netListen, err = net.FileListener(f) } else { log.Print(\"main: Listening on a new file descriptor.\") netListen, err = net.Listen(\"tcp\", gServer.Addr) } if err != nil { log.Fatal(err) return } ... } args 用于解析入参，gracefulChild 表示进程自己是否是子进程（对应到 fork 中的-graceful）（这里更推荐 flag.BoolVar，但是写 demo 的时候使用起来有些问题，故临时使用 args）\nnet.FileListener 重用套接字，ExtraFiles 中传递的套接字，从 idx 3 的位置开始获取。\n给父进程发送信号停止父进程 1 2 3 4 5 6 7 8 9 10 11 12 func main() { //init ... if gracefulChild { syscall.Kill(syscall.Getppid(), syscall.SIGTERM) log.Println(\"Graceful shutdown parent process.\") } //start http server. ... } 给父进程发送 graceful shutdown 信号\n优雅停止父进程 等待请求超时或者处理完成退出进程\n第一眼给人感觉，不知道该如何下手做热升级。\n我们需要去跟踪连接，故想到的是有没有钩子函数来解决连接的 accept 和 close，让人觉得 Golang 标准 http 包没有提供任何钩子来处理 Accept() 和 Close()，这里恰恰是 golang 的 interface 的魅力所在。\ninterface 基础知识请自行补充\n我们需要一个 sync.WaitGroup 来跟踪已经打开的连接，每新 accept 一个连接则让其加一，每当连接断开则减一。定义一个 listener struct 并实现相应的 Accept()、Close()、Addr() 等方法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 type demoListener struct { net.Listener stopped bool stop chan error } func newDemoListener(listen net.Listener) (demoListen *demoListener) { demoListen = \u0026demoListener{ Listener: listen, stop: make(chan error), } return } func (listen *demoListener) Accept() (conn net.Conn, err error) { conn, err = listen.Listener.Accept() if err != nil { return } conn = demoConn{Conn: conn} gWg.Add(1) return } func (listen *demoListener) Close() error { if listen.stopped { return syscall.EINVAL } listen.stopped = true return listen.Listener.Close() //停止接受新的连接 } //get fd func (listen *demoListener) File() *os.File { // returns a dup(2) - FD_CLOEXEC flag *not* set tcpListen := listen.Listener.(*net.TCPListener) fd, _ := tcpListen.File() return fd } demoListener 定义的时候，通过匿名结构体（可以理解为是一种组合），继承了 net.Listener 的结构和方法，下面的 Accept 和 Close 则重载了 net.Listener 的 Accept 和 Close 方法。\nListener 在每个 Accept() 上都增加了一个等待组。\nnewDemoListener() 是 Listener 的构造函数。\nFile() 方法是从 Listener 中获取文件描述符 fd\n当然，我们需要重载连接 net.Conn 的 Close() 方法，在连接断开时，将 wg 减一\n1 2 3 4 5 6 7 8 9 10 11 12 type demoConn struct { net.Conn } func (conn demoConn) Close() error { err := conn.Conn.Close() if err == nil { gWg.Done() } return nil } 最后，有可能客户端已经很长时间不发消息了，但是他不主动断开连接；为了避免这种情况，server 端通常认为这种是连接超时，在一定时间后会将连接关闭，故初始化 http.Server 时比较建议这样：\n1 2 3 4 5 6 7 gServer = \u0026http.Server{ Addr: \"0.0.0.0:8086\", ReadTimeout: 60 * time.Second, WriteTimeout: 60 * time.Second, MaxHeaderBytes: 1 \u003c\u003c 16, Handler:\tdemoHandler{}, } 注意：若使用的 go 版本在 1.8 版本以上（包括），http 包已经支持优雅退出，直接调用 Shutdown() 接口即可，更为简单。\n关闭 listener 连接和监控信号的部分这里便不再赘述，文末附有源码，有兴趣可以看看。\n测试结果：\n启动 server，发送 http 请求\n1 2 3 4 5 6 7 YOUSALI-MB0:~ yousa$ curl -i http://localhost:8086 HTTP/1.1 200 OK Date: Mon, 05 Nov 2018 08:11:17 GMT Content-Length: 17 Content-Type: text/plain; charset=utf-8 Hello Tencent! 发送 usr2 信号给 server\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 YOUSALI-MB0:graceful-restart-demo yousa$ ps -ef | grep grace 501 50199 41134 0 4:10 下午 ttys002 0:00.01 ./graceful-restart-demo 501 50252 44808 0 4:11 下午 ttys003 0:00.00 grep grace YOUSALI-MB0:graceful-restart-demo yousa$ kill -USR2 50199 YOUSALI-MB0:graceful-restart-demo yousa$ ps -ef | grep grace 501 50253 1 0 4:11 下午 ttys002 0:00.01 /Users/yousa/work/src/graceful-restart-demo/graceful-restart-demo -graceful 501 51460 44808 0 4:37 下午 ttys003 0:00.00 grep grace ## 终端打印 Hello World! gracefulChild: false 2018/11/05 16:10:16 main: Listening on a new file descriptor. 2018/11/05 16:11:10 50199 Received SIGUSR2. Hello World! gracefulChild: true 2018/11/05 16:11:10 main: Listening to existing file descriptor 3. 2018/11/05 16:11:10 Graceful shutdown parent process. 2018/11/05 16:11:10 50199 Received SIGTERM. 待升级后发送消息\n1 2 3 4 5 6 7 YOUSALI-MB0:~ yousa$ curl -i http://localhost:8086 HTTP/1.1 200 OK Date: Mon, 05 Nov 2018 08:11:44 GMT Content-Length: 14 Content-Type: text/plain; charset=utf-8 Happy 20th birthday! 遇到的问题 1、翻了下代码，并没有看到父进程如何退出？是怎样的流程？\n先看一下 http ListenAndServe 接口，它会调用 net.Listen 和 serve.Serve 两个函数，net.Listen 是 listen 端口。\nServe 代码如下，它是一个 for 循环，Accept 一个新的连接后会用一个新的协程来处理请求；当 listen 的端口被关闭或者异常后，该 Serve 循环便会跳出\n另外，也可以在这里看到，如果让 http server 接入协程池则可以重载 http.Server 的 Serve，在收到新的连接后，从协程池中分配一个协程供新的连接使用。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func (srv *Server) Serve(l net.Listener) error { defer l.Close() var tempDelay time.Duration // how long to sleep on accept failure for { rw, e := l.Accept() if e != nil { if ne, ok := e.(net.Error); ok \u0026\u0026 ne.Temporary() { if tempDelay == 0 { tempDelay = 5 * time.Millisecond } else { tempDelay *= 2 } if max := 1 * time.Second; tempDelay \u003e max { tempDelay = max } srv.logf(\"http: Accept error: %v; retrying in %v\", e, tempDelay) time.Sleep(tempDelay) continue } return e } tempDelay = 0 c, err := srv.newConn(rw) if err != nil { continue } c.setState(c.rwc, StateNew) // before Serve can return go c.serve() } } 再看一下 shutdownProcess 函数，故在这里关闭 listen socket 后，http Serve 处理请求的主循环便会退出\n1 2 3 4 5 6 func shutdownProcess() error { gServer.SetKeepAlivesEnabled(false) gListen.Close() log.Println(\"shutdownProcess success.\") return nil } 将 listen socket 关闭后，main 函数中的 gServer.Serve(gListen) 便会退出，但实际上已有的连接/服务并没有处理完成，需要使用 waitgroup 等待连接处理完成后，进程再退出。\ngithub 上的已有开源方案 解决 golang http server 热更新问题，有了基本的思路之后，想到的是去 github 看下有没有稳定的解决方案。找到了如下三个库：\nfvbock/endless - Zero downtime restarts for golang HTTP and HTTPS servers. (for golang 1.3+) facebookgo/grace - Grace provides a library that makes it easy to build socket based servers that can be gracefully terminated \u0026 restarted (that is, without dropping any connections). jpillora/overseer - Overseer is a package for creating monitorable, gracefully restarting, self-upgrading binaries in Go (golang) 其实除了这些外，还有一些支持热更新的库，但是更新时间过老，在这里就不作讨论了。 当然，非常火爆的框架比如 beego 等，也支持热升级/gracefun shutdown，但是由于嵌入到了 beego 中，故本章中不作讨论，有兴趣的可以自行去看看。\n实现浅析 我们使用官方的例子来简单分析其流程并简单比较其异同\n1、各个开源库 demo 代码 demo 代码较为冗长，很影响阅读观感，故贴在了最后的附录中\n2、对比 操作步骤：\n编译 demo 示例，启动示例进程，记录其 pid 修改内容 (Hello Tencent 初始内容，修改为 Happy 20th Birthday！且请求处理均需要 sleep 10-20 秒），重新构建。 发送请求，发送热升级信号，再发送请求，对比两次请求内容 对比进程热升级前后的 pid，是否与之前一致 结果对比\n第三方库 第一次请求返回 第二次请求返回 操作前进程 pid 操作后进程 pid facebookgo/grace Hello Tencent Happy 20th Birthday！ 41992 41998 fvbock/endless Hello Tencent Happy 20th Birthday！ 41200 41520 jpillora/overseer Hello Tencent Happy 20th Birthday！ 43424 43424 原理浅析：\ngrace 和 endless 的热升级方法与本文重点讲述的方法一致，基本是 fork 一个子进程，子进程 listen 端口，父进程优雅退出，这里便不再赘述\noverseer 的热升级与 grace/endless 有些不同，由于作者很久不更新了（差不多 1-2 年），也找不到比较好的介绍文章，故这里只能简要贴一下其 github 上对 overseer 的原理介绍。由于不是本文核心介绍内容，放在附录中。 overseer 用一个主进程管理平滑重启，子进程处理连接，保持主进程 pid 不变；\n优缺点对比：\ngrace 库支持 net tcp 热升级以及 http 热升级，endless 仅支持 http 热升级 grace 库接入第三方 http server 较麻烦（比如 fasthttp、gin 等）；endless 接入则只需要替换 ListenAndServe 即可（endless 继承/重写了 Serve 方法），通用性更好 grace 库功能强大，但是稍微复杂；endless 库更为简洁 由于我的项目使用了 gin 作为 http 框架，故考虑到快速集成，我选择了 endless 该框架\n第三方库的对比经验： 主观因素：个人品味，是否要自己造轮子，朋友的推荐也对个人的判断也有很大影响； 客观因素：集成复杂度，内存管理，是否有大量 I/O 访问/耗性能访问，错误处理，工具参考文档等。\n集成起来也非常方便，类似于如下：\n1 2 3 4 5 6 func main() { router := gin.Default() router.GET(\"/\", handler) // [...] endless.ListenAndServe(\":8086\", router) } 问题拓展 我其实又想了这些问题，也想抛出来与大家一起讨论\n1、简单的 http server 很容易升级，若监听了多个端口该如何进行热升级？\n2、若 go server 使用 tls 服务（其他也类似），如何进行升级？\n3、go http server 在容器场景下是否需要平滑热升级？平滑停机是否足够？如果平滑停机足够的话，那么如何结合 docker+k8s 进行热升级？\n个人猜测了一下，这种场景下，后端服务应该会有冗余部署，前端通过负载均衡/elb/tgw 等中间层访问，或者使用 consul 之类的服务注册发现机制，串行重启或者分批次重启，来做到不停服升级服务\n总结 热更新目标：\n1、正在处理中的连接/服务/请求不能立即中断，需要继续提供服务 2、socket 对用户来说要保持可用，可以接受新的请求 直接沿用上篇的思路，热更新（单进程）流程，其基本流程如下：\n1、用新的 bin 文件去替换老的 bin 文件 2、发送信号告知 server 进程（通常是 USR2 信号），进行平滑升级 3、server 进程收到信号后，通过调用 fork/exec 启动新的版本的进程 4、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket 5、老的进程不再接受请求，待正在处理中的请求处理完后，进程自动退出 6、子进程托管给 init 进程 参考 https://grisha.org/blog/2014/06/03/graceful-restart-in-golang/ https://blog.csdn.net/u012058778/article/details/78705536 http://gulu-dev.com/post/2014-07-28-tech-evaluation https://golang.org/doc/go1.8#http_shutdown golang1.8 升级日志，支持 gracefulshutdown 代码附录 1、facebookgo/grace 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // Command gracedemo implements a demo server showing how to gracefully // terminate an HTTP server using grace. package main import ( \"flag\" \"fmt\" \"net/http\" \"os\" \"time\" \"github.com/facebookgo/grace/gracehttp\" ) var ( address0 = flag.String(\"a0\", \":48567\", \"Zero address to bind to.\") address1 = flag.String(\"a1\", \":48568\", \"First address to bind to.\") address2 = flag.String(\"a2\", \":48569\", \"Second address to bind to.\") now = time.Now() ) func main() { flag.Parse() gracehttp.Serve( \u0026http.Server{Addr: *address0, Handler: newHandler(\"Zero \")}, \u0026http.Server{Addr: *address1, Handler: newHandler(\"First \")}, \u0026http.Server{Addr: *address2, Handler: newHandler(\"Second\")}, ) } func newHandler(name string) http.Handler { mux := http.NewServeMux() mux.HandleFunc(\"/sleep/\", func(w http.ResponseWriter, r *http.Request) { duration, err := time.ParseDuration(r.FormValue(\"duration\")) if err != nil { http.Error(w, err.Error(), 400) return } time.Sleep(duration) fmt.Fprintf( w, \"%s started at %s slept for %d nanoseconds from pid %d.\\n\", name, now, duration.Nanoseconds(), os.Getpid(), ) }) return mux } 2、fvbock/endless 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 package main import ( \"log\" \"net/http\" \"os\" \"github.com/fvbock/endless\" \"github.com/gorilla/mux\" ) func handler(w http.ResponseWriter, r *http.Request) { w.Write([]byte(\"WORLD!\")) } func main() { mux1 := mux.NewRouter() mux1.HandleFunc(\"/hello\", handler). Methods(\"GET\") err := endless.ListenAndServe(\"localhost:4242\", mux1) if err != nil { log.Println(err) } log.Println(\"Server on 4242 stopped\") os.Exit(0) } 3、jpillora/overseer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package main import ( \"fmt\" \"net/http\" \"time\" \"github.com/jpillora/overseer\" \"github.com/jpillora/overseer/fetcher\" ) //see example.sh for the use-case // BuildID is compile-time variable var BuildID = \"0\" //convert your 'main()' into a 'prog(state)' //'prog()' is run in a child process func prog(state overseer.State) { fmt.Printf(\"app#%s (%s) listening...\\n\", BuildID, state.ID) http.Handle(\"/\", http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { d, _ := time.ParseDuration(r.URL.Query().Get(\"d\")) time.Sleep(d) fmt.Fprintf(w, \"app#%s (%s) says hello\\n\", BuildID, state.ID) })) http.Serve(state.Listener, nil) fmt.Printf(\"app#%s (%s) exiting...\\n\", BuildID, state.ID) } //then create another 'main' which runs the upgrades //'main()' is run in the initial process func main() { overseer.Run(overseer.Config{ Program: prog, Address: \":5001\", Fetcher: \u0026fetcher.File{Path: \"my_app_next\"}, Debug: false, //display log of overseer actions }) } 4、overseer overseer uses the main process to check for and install upgrades and a child process to run Program.\nThe main process retrieves the files of the listeners described by Address/es.\nThe child process is provided with these files which is converted into a Listener/s for the Program to consume.\nAll child process pipes are connected back to the main process.\nAll signals received on the main process are forwarded through to the child process.\nFetcher runs in a goroutine and checks for updates at preconfigured interval. When Fetcher returns a valid binary stream (io.Reader), the master process saves it to a temporary location, verifies it, replaces the current binary and initiates a graceful restart.\nThe fetcher.HTTP accepts a URL, it polls this URL with HEAD requests and until it detects a change. On change, we GET the URL and stream it back out to overseer. See also fetcher.S3.\nOnce a binary is received, it is run with a simple echo token to confirm it is a overseer binary.\nExcept for scheduled restarts, the active child process exiting will cause the main process to exit with the same code. So, overseer is not a process manager.\n[外链图片转存失败，源站可能有防盗链机制，建议将图片保存下来直接上传 (img-nJwx0ZVC-1609089892264)(https://camo.githubusercontent.com/45df268c40025baddcafea70a437537c8c67b31c/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f316f31326e6a597952494c79335544733245364a7a794a456c3070735534655059694d5132306a6975564f592f7075623f773d35363626683d323834)]\n参考 http://tengine.taobao.org/nginx_docs/cn/docs/control.html\n附加技巧 nginx 如何在指定时间内热重启？\nenvoy 热重启流程跟一般golang进程、nginx进程又有什么异同？\n","wordCount":"2624","inLanguage":"en","datePublished":"2020-12-28T01:23:35+08:00","dateModified":"2020-12-28T01:32:25+08:00","author":{"@type":"Person","name":"[厉辉（Yousa）](https://github.com/Miss-you)"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://miss-you.github.io/posts/server-hot-update/"},"publisher":{"@type":"Organization","name":"Yousa Driven Development | YDD","logo":{"@type":"ImageObject","url":"https://miss-you.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://miss-you.github.io/ accesskey=h title="Yousa Driven Development | YDD (Alt + H)">Yousa Driven Development | YDD</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://miss-you.github.io/zh/ title=中文 aria-label=中文>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://miss-you.github.io/archives title=归档><span>归档</span></a></li><li><a href=https://miss-you.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://miss-you.github.io/tools/ title=工具><span>工具</span></a></li><li><a href=https://miss-you.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://github.com/Miss-you title=GitHub><span>GitHub</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://miss-you.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://miss-you.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">从 nginx 热更新聊一聊 Golang 中的热更新</h1><div class=post-meta><span title='2020-12-28 01:23:35 +0800 +0800'>December 28, 2020</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;17733 字&nbsp;·&nbsp;[厉辉（Yousa）](https://github.com/Miss-you)&nbsp;|&nbsp;<a href=https://github.com/Miss-you/miss-you.github.io/tree/main/content/posts/server-hot-update.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#热更新是什么>热更新是什么？</a></li><li><a href=#网关中的热更新>网关中的热更新</a></li><li><a href=#nginx-热更新-upgrading-executable-on-the-fly>nginx 热更新 (Upgrading Executable on the Fly)</a><ul><li><a href=#nginx-热升级流程>nginx 热升级流程</a></li><li><a href=#nginx-热更新相关信号>nginx 热更新相关信号</a></li><li><a href=#nginx-相关代码走读>nginx 相关代码走读</a></li><li><a href=#nginx-升级过程中若出现问题如何回滚>nginx 升级过程中若出现问题如何回滚？</a></li><li><a href=#nginx-热升级-qa>nginx 热升级 QA</a></li><li><a href=#总结一下个人在-nginx-二进制文件热升级时用的命令>总结一下个人在 nginx 二进制文件热升级时用的命令</a></li></ul></li><li><a href=#热升级>热升级</a></li><li><a href=#热更新>热更新</a><ul><li><a href=#简易的-http-server>简易的 http server</a></li><li><a href=#fork-一个新的进程>fork 一个新的进程</a></li><li><a href=#子进程初始化>子进程初始化</a></li><li><a href=#给父进程发送信号停止父进程>给父进程发送信号停止父进程</a></li><li><a href=#优雅停止父进程>优雅停止父进程</a></li><li><a href=#遇到的问题>遇到的问题</a></li></ul></li><li><a href=#github-上的已有开源方案>github 上的已有开源方案</a><ul><li><a href=#实现浅析>实现浅析</a></li><li><a href=#问题拓展>问题拓展</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li><li><a href=#代码附录>代码附录</a><ul><li></li></ul></li><li><a href=#参考-1>参考</a></li><li><a href=#附加技巧>附加技巧</a></li></ul></nav></div></details></div><div class=post-content><h1 id=从-nginx-热更新聊一聊-golang-中的热更新>从 nginx 热更新聊一聊 Golang 中的热更新<a hidden class=anchor aria-hidden=true href=#从-nginx-热更新聊一聊-golang-中的热更新>#</a></h1><blockquote><p>静态语言在服务器编程时都会遇到这样的问题：如何保证已有的连接服务不中断同时又升级版本？
最近花了点时间看了下 nginx 热更新代码流程，想了下结合之前的经验一并总结下热更新</p></blockquote><h2 id=热更新是什么>热更新是什么？<a hidden class=anchor aria-hidden=true href=#热更新是什么>#</a></h2><p>举个例子，你现在在坐卡车，卡车开到了 150KM/H</p><p>然后，有个轮胎，爆了</p><p>然后，司机说，你就直接换吧，我不停车。你小心点换</p><p>嗯。就这个意思</p><h2 id=网关中的热更新>网关中的热更新<a hidden class=anchor aria-hidden=true href=#网关中的热更新>#</a></h2><p>服务程序热更新这个问题在层 7 网关中尤其严重，网关中承载着大量的请求，包括 HTTP/HTTPS 短连接、HTTP/HTTPS 长连接、甚至是 websocket 这种超长连接（websocket 通常连接时间会很长，十几分钟到几天不等）。服务进程热更新是非常有必要的。</p><p>网关作为一个基础组件，需要保证高可用，是很难将其先停下来再更新的；</p><p>有人说可以使用负载均衡将需要更新的组件先隔离，再停机更新，但是如果是一个很小的集群没有负载均衡呢，又或者这样手动一台一台升级也着实麻烦，部分情况下就算隔离了也不过是不会有新的连接过来，旧的连接/请求依旧需要处理完成，否则就会造成部分服务不可用</p><blockquote><p>不过实际上线上操作是集群隔离加热更新一起操作</p></blockquote><h2 id=nginx-热更新-upgrading-executable-on-the-fly>nginx 热更新 (Upgrading Executable on the Fly)<a hidden class=anchor aria-hidden=true href=#nginx-热更新-upgrading-executable-on-the-fly>#</a></h2><p>nginx [engine x] 是 Igor Sysoev 编写的一个 HTTP 和反向代理服务器，另外它也可以作为邮件代理服务器。 它已经在众多流量很大的俄罗斯网站上使用了很长时间，这些网站包括 Yandex、Mail.Ru、VKontakte，以及 Rambler。据 Netcraft 统计，在 2012 年 8 月份，世界上最繁忙的网站中有 11.48%使用 Nginx 作为其服务器或者代理服务器。</p><blockquote><p>NginX 采用 Master/Worker 的多进程模型，Master 进程负责整个 NginX 进程的管理。Nginx 的模块化、热更新、Http 处理流程、日志等机制都非常经典。这里将会简要介绍一下热更新的机制</p></blockquote><h3 id=nginx-热升级流程>nginx 热升级流程<a hidden class=anchor aria-hidden=true href=#nginx-热升级流程>#</a></h3><p>步骤 1、升级 nginx 二进制文件，需要先将新的 nginx 可执行文件替换原有旧的 nginx 文件，然后给 nginx master 进程发送 USR2 信号，告知其开始升级可执行文件；nginx master 进程会将老的 pid 文件增加。oldbin 后缀，然后拉起新的 master 和 worker 进程，并写入新的 master 进程的 pid。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7>7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8>8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>UID        PID  PPID  C STIME TTY          TIME CMD
</span></span><span class=line><span class=cl>root      4584     1  0 Oct17 ?        00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx
</span></span><span class=line><span class=cl>root     12936  4584  0 Oct26 ?        00:03:24 nginx: worker process
</span></span><span class=line><span class=cl>root     12937  4584  0 Oct26 ?        00:00:04 nginx: worker process
</span></span><span class=line><span class=cl>root     12938  4584  0 Oct26 ?        00:00:04 nginx: worker process
</span></span><span class=line><span class=cl>root     23692  4584  0 21:28 ?        00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx
</span></span><span class=line><span class=cl>root     23693 23692  3 21:28 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root     23694 23692  3 21:28 ?        00:00:00 nginx: worker process
</span></span><span class=line><span class=cl>root     23695 23692  3 21:28 ?        00:00:00 nginx: worker process
</span></span></code></pre></td></tr></table></div></div><p>步骤 2、在此之后，所有工作进程（包括旧进程和新进程）将会继续接受请求。这时候，需要发送 WINCH 信号给 nginx master 进程，master 进程将会向 worker 进程发送消息，告知其需要进行 graceful shutdown，worker 进程会在连接处理完之后进行退出。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>UID        PID  PPID  C STIME TTY          TIME CMD
</span></span><span class=line><span class=cl>root      4584     1  0 Oct17 ?        00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx
</span></span><span class=line><span class=cl>root     12936  4584  0 Oct26 ?        00:03:24 nginx: worker process
</span></span><span class=line><span class=cl>root     12937  4584  0 Oct26 ?        00:00:04 nginx: worker process
</span></span><span class=line><span class=cl>root     12938  4584  0 Oct26 ?        00:00:04 nginx: worker process
</span></span><span class=line><span class=cl>root     23692  4584  0 21:28 ?        00:00:00 nginx: master process /usr/local/apigw/apigw_nginx/nginx
</span></span><span class=line><span class=cl>#若旧的 worker 进程还需要处理连接，则 worker 进程不会立即退出，需要待消息处理完后再退出
</span></span></code></pre></td></tr></table></div></div><p>步骤 3、经过一段时间之后，将会只会有新的 worker 进程处理新的连接。</p><blockquote><p>注意，旧 master 进程并不会关闭它的 listen socket；因为如果出问题后，需要回滚，master 进程需要法重新启动它的 worker 进程。</p></blockquote><p>步骤 4、如果升级成功，则可以向旧 master 进程发送 QUIT 信号，停止老的 master 进程；如果新的 master 进程（意外）退出，那么旧 master 进程将会去掉自己的 pid 文件的。oldbin 后缀。</p><h3 id=nginx-热更新相关信号>nginx 热更新相关信号<a hidden class=anchor aria-hidden=true href=#nginx-热更新相关信号>#</a></h3><p>master 进程相关信号</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>USR2	升级可执行文件
</span></span><span class=line><span class=cl>WINCH	优雅停止 worker 进程
</span></span><span class=line><span class=cl>QUIT	优雅停止 master 进程
</span></span></code></pre></td></tr></table></div></div><p>worker 进程相关信号</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>TERM, INT	快速退出进程
</span></span><span class=line><span class=cl>QUIT	优雅停止进程
</span></span></code></pre></td></tr></table></div></div><h3 id=nginx-相关代码走读>nginx 相关代码走读<a hidden class=anchor aria-hidden=true href=#nginx-相关代码走读>#</a></h3><h4 id=1usr2-流程>1、USR2 流程<a hidden class=anchor aria-hidden=true href=#1usr2-流程>#</a></h4><p><img alt=在这里插入图片描述 loading=lazy src="https://img-blog.csdnimg.cn/20181029211941159.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE1NDM3NjY3,size_16,color_FFFFFF,t_70"></p><p>master 收到 USR2 信号后，会拉起新的 master nginx 进程；</p><p>新的 master 进程拉起新的 worker 进程；</p><p>最终，老的 worker 进程和新的 worker 进程共用一个 listen socket，接受连接</p><blockquote><p>若打开了 REUSEPORT 开关，则 socket 继承情况会有些区别，感兴趣的可以自行翻看代码</p></blockquote><h4 id=2winch-流程>2、WINCH 流程<a hidden class=anchor aria-hidden=true href=#2winch-流程>#</a></h4><p><img alt=在这里插入图片描述 loading=lazy src="https://img-blog.csdnimg.cn/20181030095755923.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE1NDM3NjY3,size_16,color_FFFFFF,t_70"></p><p>master 进程收到 WINCH 信号后，会给各个 worker 进程发送 QUIT 信号，让其优雅退出；master 进程并不再处理新的连接。</p><p><img alt=在这里插入图片描述 loading=lazy src="https://img-blog.csdnimg.cn/20181030105115956.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE1NDM3NjY3,size_16,color_FFFFFF,t_70"></p><p>worker graceful shutdown 流程，关闭 listen socket，不再处理新的连接；待已有连接处理完后，清理连接，退出进程。</p><h4 id=3quit-流程>3、QUIT 流程<a hidden class=anchor aria-hidden=true href=#3quit-流程>#</a></h4><p>master graceful shutdown 流程，没什么好说的</p><h3 id=nginx-升级过程中若出现问题如何回滚>nginx 升级过程中若出现问题如何回滚？<a hidden class=anchor aria-hidden=true href=#nginx-升级过程中若出现问题如何回滚>#</a></h3><h3 id=nginx-热升级-qa>nginx 热升级 QA<a hidden class=anchor aria-hidden=true href=#nginx-热升级-qa>#</a></h3><p><strong>1、如何防止多次可执行文件触发热更新？</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>相关代码</span>
</span></span><span class=line><span class=cl><span class=n>ngx_signal_handler</span>
</span></span><span class=line><span class=cl><span class=o>--&gt;</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=n>ngx_signal_value</span><span class=p>(</span><span class=n>NGX_CHANGEBIN_SIGNAL</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ngx_getppid</span><span class=p>()</span> <span class=o>==</span> <span class=n>ngx_parent</span> <span class=o>||</span> <span class=n>ngx_new_binary</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>/*</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>Ignore</span> <span class=n>the</span> <span class=k>signal</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>new</span> <span class=n>binary</span> <span class=k>if</span> <span class=n>its</span> <span class=n>parent</span> <span class=n>is</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=ow>not</span> <span class=n>changed</span><span class=p>,</span> <span class=n>i</span><span class=o>.</span><span class=n>e</span><span class=o>.</span> <span class=n>the</span> <span class=n>old</span> <span class=n>binary</span><span class=s1>&#39;s process is still</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>running</span><span class=o>.</span>  <span class=n>Or</span> <span class=n>ignore</span> <span class=n>the</span> <span class=k>signal</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>old</span> <span class=n>binary</span><span class=s1>&#39;s</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span> <span class=n>process</span> <span class=k>if</span> <span class=n>the</span> <span class=n>new</span> <span class=n>binary</span><span class=s1>&#39;s process is already running.</span>
</span></span><span class=line><span class=cl>            <span class=o>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>action</span> <span class=o>=</span> <span class=s2>&#34;, ignoring&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ignore</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ngx_change_binary</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span> <span class=o>=</span> <span class=s2>&#34;, changing binary&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>若老的 nginx 还在，nginx 无法进行热更新二进制文件</p><p><strong>2、nginx 升级过程中，发现新的可执行文件出现问题该如何回滚？</strong></p><ul><li>a、向旧 master 进程发送 HUP 信号。旧进程将启动新的 worker 进程，而且不会重新读取配置。之后，通过向新的主 master 进程发送 QUIT 信号，可以优雅地关闭新的 master 和 worker 进程。</li><li>b、将 TERM 信号发送到新的 master 进程，然后新的 master 进程将向其 worker 进程发送一条消息，让它们立即退出，这种退出不是 graceful shutdown。当新的 master 进程退出时，旧的 master 进程将启动新的 worker 进程。</li><li>c、如果新的进程没有退出，则应该向它们发送终止 KILL 信号。当新的 master 进程退出时，旧的 master 进程将启动新的工作进程。</li></ul><p><strong>3、什么是 graceful shutdown</strong></p><p>本文中的 graceful shutdown 是指 server 不再处理新的连接，但是进程不会立即退出，待所有连接断开后再退出进程。</p><h3 id=总结一下个人在-nginx-二进制文件热升级时用的命令>总结一下个人在 nginx 二进制文件热升级时用的命令<a hidden class=anchor aria-hidden=true href=#总结一下个人在-nginx-二进制文件热升级时用的命令>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd /usr/local/nginx
</span></span><span class=line><span class=cl>cp nginx nginx_bak 
</span></span><span class=line><span class=cl>mv /data/nginx/nginx ./nginx #需要使用 mv 来更新二进制文件
</span></span><span class=line><span class=cl>./nginx -t #尝试启动，查看其加载配置文件等初始化功能是否正常
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>netstat -anp | grep -E &#34;80|443&#34; | grep nginx #检查连接状态
</span></span><span class=line><span class=cl>kill -USR2 `cat /usr/local/nginx/nginx.pid` #升级 nginx 可执行文件，此时会有两组 nginx master 和 worker 进程
</span></span><span class=line><span class=cl>kill -WINCH `cat /usr/local/nginx/nginx.pid.oldbin` #新的可执行文件启动 ok，且能够正常处理数据流，告知老的 master 进程去通知其 worker 进程进行优雅退出
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>kill -QUIT `cat /usr/local/nginx/nginx.pid.oldbin` #待所有的老的 nginx worker 进程优雅退出后（处理完连接），停止老的 master 进程
</span></span></code></pre></td></tr></table></div></div><blockquote><p>TODO：nginx 还会有依赖的 so 文件的热升级&ndash;其实更应该属于后台进程的 so 文件热升级流程，我在使用它的时候也踩过坑&ndash;主要原因还是操作不规范，对 so 其加载运行原理不够熟悉导致</p></blockquote><h2 id=热升级>热升级<a hidden class=anchor aria-hidden=true href=#热升级>#</a></h2><p>实际上，静态语言后端 server 有一套固定的热升级（单进程）流程，其基本流程如下：</p><blockquote><p>若需要支持热升级的是多进程，那么 nginx 的热升级过程是最值得参考的</p></blockquote><ul><li><p>1、通过调用 fork/exec 启动新的版本的进程，</p></li><li><p>2、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket</p></li><li><p>3、在此过程中，不会对用户请求造成任何中断。</p></li></ul><p>nginx 的热升级流程也是类似，只不过由于 nginx 工作是多进程，故它会先启动新版本的一组 master/worker 进程；</p><p>然后停止老的 worker 进程，让其不处理连接，由新的 worker 进程来处理连接；</p><p>升级完毕后，即可退出老的 master 进程，热升级完成。</p><h2 id=热更新>热更新<a hidden class=anchor aria-hidden=true href=#热更新>#</a></h2><p>热更新目标：</p><ul><li>1、正在处理中的连接/服务/请求不能立即中断，需要继续提供服务</li><li>2、socket 对用户来说要保持可用，可以接受新的请求</li></ul><p>直接沿用上篇的思路，热更新（单进程）流程，其基本流程如下：</p><ul><li>1、用新的 bin 文件去替换老的 bin 文件</li><li>2、发送信号告知 server 进程（通常是 USR2 信号），进行平滑升级</li><li>3、server 进程收到信号后，通过调用 fork/exec 启动新的版本的进程</li><li>4、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket</li><li>5、老的进程不再接受请求，待正在处理中的请求处理完后，进程自动退出</li><li>6、子进程托管给 init 进程</li></ul><p>我们可以按照这个思路完成一个简单的可以热更新的 http server</p><h3 id=简易的-http-server>简易的 http server<a hidden class=anchor aria-hidden=true href=#简易的-http-server>#</a></h3><p>首先，我们需要一个最简单的 http server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;Hello World!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=n>err</span> <span class=n>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>注册</span> <span class=n>http</span> <span class=err>请求的处理方法</span>
</span></span><span class=line><span class=cl>    <span class=n>http</span><span class=o>.</span><span class=n>HandleFunc</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=k>func</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>w</span><span class=o>.</span><span class=n>Write</span><span class=p>([]</span><span class=n>byte</span><span class=p>(</span><span class=s2>&#34;Hello world!&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>在</span> <span class=mi>8086</span> <span class=err>端口启动</span> <span class=n>http</span> <span class=err>服务，其内部有一个循环</span> <span class=n>accept</span> <span class=mi>8086</span> <span class=err>端口</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=err>每当新的</span> <span class=n>HTTP</span> <span class=err>请求过来则开一个协程处理</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span> <span class=o>=</span> <span class=n>http</span><span class=o>.</span><span class=n>ListenAndServe</span><span class=p>(</span><span class=s2>&#34;localhost:8086&#34;</span><span class=p>,</span> <span class=n>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=fork-一个新的进程>fork 一个新的进程<a hidden class=anchor aria-hidden=true href=#fork-一个新的进程>#</a></h3><p>在 go 语言里面可以有很多种方法 fork 一个新的进程，但是在这里我更倾向于推荐 exec.Command 接口来启动一个新的进程。因为 Cmd struct 中有一个 ExtraFiles 变量，子进程可以通过它直接继承文件描述符 fd。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21>21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22>22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23>23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24>24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25>25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26>26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27>27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28>28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>forkProcess</span><span class=p>()</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>err</span> <span class=n>error</span>
</span></span><span class=line><span class=cl>	<span class=n>files</span> <span class=p>:</span><span class=o>=</span> <span class=p>[]</span><span class=o>*</span><span class=n>os</span><span class=o>.</span><span class=n>File</span><span class=p>{</span><span class=n>gListen</span><span class=o>.</span><span class=n>File</span><span class=p>()}</span> <span class=o>//</span><span class=n>demo</span> <span class=n>only</span> <span class=n>one</span> <span class=o>//.</span><span class=n>File</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>path</span> <span class=p>:</span><span class=o>=</span> <span class=s2>&#34;/Users/yousa/work/src/graceful-restart-demo/graceful-restart-demo&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>args</span> <span class=p>:</span><span class=o>=</span> <span class=p>[]</span><span class=n>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;-graceful&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>env</span> <span class=p>:</span><span class=o>=</span> <span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=n>os</span><span class=o>.</span><span class=n>Environ</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;ENDLESS_CONTINUE=1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>env</span> <span class=o>=</span> <span class=n>append</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>fmt</span><span class=o>.</span><span class=n>Sprintf</span><span class=p>(</span><span class=err>`</span><span class=n>ENDLESS_SOCKET_ORDER</span><span class=o>=%</span><span class=n>s</span><span class=err>`</span><span class=p>,</span> <span class=s2>&#34;0,127.0.0.1&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>cmd</span> <span class=p>:</span><span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=n>Command</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>args</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>cmd</span> <span class=p>:</span><span class=o>=</span> <span class=n>exec</span><span class=o>.</span><span class=n>Command</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;-graceful&#34;</span><span class=p>,</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>cmd</span><span class=o>.</span><span class=n>Stdout</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>Stdout</span>
</span></span><span class=line><span class=cl>	<span class=n>cmd</span><span class=o>.</span><span class=n>Stderr</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>Stderr</span>
</span></span><span class=line><span class=cl>	<span class=n>cmd</span><span class=o>.</span><span class=n>ExtraFiles</span> <span class=o>=</span> <span class=n>files</span>
</span></span><span class=line><span class=cl>	<span class=n>cmd</span><span class=o>.</span><span class=n>Env</span> <span class=o>=</span> <span class=n>env</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=o>=</span> <span class=n>cmd</span><span class=o>.</span><span class=n>Start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>log</span><span class=o>.</span><span class=n>Fatalf</span><span class=p>(</span><span class=s2>&#34;Restart: Failed to launch, error: %v&#34;</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>代码浅析：</p><p>在上面的 files 是存储父进程的文件描述符，path 的内容是新的要替换的可执行文件的路径。</p><p>重要的一点是，.File() 返回一个 <a href=http://pubs.opengroup.org/onlinepubs/009695399/functions/dup.html>dup(2)</a> 的文件描述符。这个重复的文件描述符不会设置 FD_CLOEXEC 标志，这个文件描述符操作容易出错，容易被在子进程中被错误关闭。</p><p>在其他语言（或者 go 里面）里面你可能通过使用命令行将文件描述符传递给子进程，在这里比较推荐使用 ExtraFile 传递 fd。不过 ExtraFiles 在 windows 中不支持。</p><p>args 中传递的-graceful 参数是告诉子进程这是优雅热升级的一部分，这样子进程可以通过它知道，自己需要重用套接字而不是重新打开一个新的套接字</p><h3 id=子进程初始化>子进程初始化<a hidden class=anchor aria-hidden=true href=#子进程初始化>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;Hello World!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=n>gracefulChild</span> <span class=ne>bool</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>netListen</span> <span class=n>net</span><span class=o>.</span><span class=n>Listener</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>err</span> <span class=n>error</span>
</span></span><span class=line><span class=cl>	<span class=n>args</span> <span class=p>:</span><span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>Args</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>len</span><span class=p>(</span><span class=n>args</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;-graceful&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>gracefulChild</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>gracefulChild</span> <span class=o>=</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;gracefulChild:&#34;</span><span class=p>,</span> <span class=n>gracefulChild</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>gracefulChild</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span><span class=err>重用套接字</span>
</span></span><span class=line><span class=cl>        <span class=nb>log</span><span class=o>.</span><span class=n>Print</span><span class=p>(</span><span class=s2>&#34;main: Listening to existing file descriptor 3.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span> <span class=p>:</span><span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>NewFile</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>netListen</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>FileListener</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>log</span><span class=o>.</span><span class=n>Print</span><span class=p>(</span><span class=s2>&#34;main: Listening on a new file descriptor.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>netListen</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>Listen</span><span class=p>(</span><span class=s2>&#34;tcp&#34;</span><span class=p>,</span> <span class=n>gServer</span><span class=o>.</span><span class=n>Addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>log</span><span class=o>.</span><span class=n>Fatal</span><span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>args 用于解析入参，gracefulChild 表示进程自己是否是子进程（对应到 fork 中的-graceful）（这里更推荐 flag.BoolVar，但是写 demo 的时候使用起来有些问题，故临时使用 args）</p><p>net.FileListener 重用套接字，ExtraFiles 中传递的套接字，从 idx 3 的位置开始获取。</p><h3 id=给父进程发送信号停止父进程>给父进程发送信号停止父进程<a hidden class=anchor aria-hidden=true href=#给父进程发送信号停止父进程>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>init</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>gracefulChild</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>syscall</span><span class=o>.</span><span class=n>Kill</span><span class=p>(</span><span class=n>syscall</span><span class=o>.</span><span class=n>Getppid</span><span class=p>(),</span> <span class=n>syscall</span><span class=o>.</span><span class=n>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;Graceful shutdown parent process.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>start</span> <span class=n>http</span> <span class=n>server</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>给父进程发送 graceful shutdown 信号</p><h3 id=优雅停止父进程>优雅停止父进程<a hidden class=anchor aria-hidden=true href=#优雅停止父进程>#</a></h3><blockquote><p>等待请求超时或者处理完成退出进程</p></blockquote><p>第一眼给人感觉，不知道该如何下手做热升级。</p><p>我们需要去跟踪连接，故想到的是有没有钩子函数来解决连接的 accept 和 close，让人觉得 Golang 标准 http 包没有提供任何钩子来处理 Accept() 和 Close()，这里恰恰是 golang 的 interface 的魅力所在。</p><blockquote><p>interface 基础知识请自行补充</p></blockquote><p>我们需要一个 sync.WaitGroup 来跟踪已经打开的连接，每新 accept 一个连接则让其加一，每当连接断开则减一。定义一个 listener struct 并实现相应的 Accept()、Close()、Addr() 等方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span><span class=lnt id=hl-10-24><a class=lnlinks href=#hl-10-24>24</a>
</span><span class=lnt id=hl-10-25><a class=lnlinks href=#hl-10-25>25</a>
</span><span class=lnt id=hl-10-26><a class=lnlinks href=#hl-10-26>26</a>
</span><span class=lnt id=hl-10-27><a class=lnlinks href=#hl-10-27>27</a>
</span><span class=lnt id=hl-10-28><a class=lnlinks href=#hl-10-28>28</a>
</span><span class=lnt id=hl-10-29><a class=lnlinks href=#hl-10-29>29</a>
</span><span class=lnt id=hl-10-30><a class=lnlinks href=#hl-10-30>30</a>
</span><span class=lnt id=hl-10-31><a class=lnlinks href=#hl-10-31>31</a>
</span><span class=lnt id=hl-10-32><a class=lnlinks href=#hl-10-32>32</a>
</span><span class=lnt id=hl-10-33><a class=lnlinks href=#hl-10-33>33</a>
</span><span class=lnt id=hl-10-34><a class=lnlinks href=#hl-10-34>34</a>
</span><span class=lnt id=hl-10-35><a class=lnlinks href=#hl-10-35>35</a>
</span><span class=lnt id=hl-10-36><a class=lnlinks href=#hl-10-36>36</a>
</span><span class=lnt id=hl-10-37><a class=lnlinks href=#hl-10-37>37</a>
</span><span class=lnt id=hl-10-38><a class=lnlinks href=#hl-10-38>38</a>
</span><span class=lnt id=hl-10-39><a class=lnlinks href=#hl-10-39>39</a>
</span><span class=lnt id=hl-10-40><a class=lnlinks href=#hl-10-40>40</a>
</span><span class=lnt id=hl-10-41><a class=lnlinks href=#hl-10-41>41</a>
</span><span class=lnt id=hl-10-42><a class=lnlinks href=#hl-10-42>42</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>type</span> <span class=n>demoListener</span> <span class=n>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>net</span><span class=o>.</span><span class=n>Listener</span>
</span></span><span class=line><span class=cl>	<span class=n>stopped</span> <span class=ne>bool</span>
</span></span><span class=line><span class=cl>	<span class=n>stop</span>    <span class=n>chan</span> <span class=n>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>newDemoListener</span><span class=p>(</span><span class=n>listen</span> <span class=n>net</span><span class=o>.</span><span class=n>Listener</span><span class=p>)</span> <span class=p>(</span><span class=n>demoListen</span> <span class=o>*</span><span class=n>demoListener</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>demoListen</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>demoListener</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Listener</span><span class=p>:</span> <span class=n>listen</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>stop</span><span class=p>:</span> <span class=n>make</span><span class=p>(</span><span class=n>chan</span> <span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>listen</span> <span class=o>*</span><span class=n>demoListener</span><span class=p>)</span> <span class=n>Accept</span><span class=p>()</span> <span class=p>(</span><span class=n>conn</span> <span class=n>net</span><span class=o>.</span><span class=n>Conn</span><span class=p>,</span> <span class=n>err</span> <span class=n>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>conn</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>listen</span><span class=o>.</span><span class=n>Listener</span><span class=o>.</span><span class=n>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>conn</span> <span class=o>=</span> <span class=n>demoConn</span><span class=p>{</span><span class=n>Conn</span><span class=p>:</span> <span class=n>conn</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>gWg</span><span class=o>.</span><span class=n>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>listen</span> <span class=o>*</span><span class=n>demoListener</span><span class=p>)</span> <span class=n>Close</span><span class=p>()</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>listen</span><span class=o>.</span><span class=n>stopped</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>syscall</span><span class=o>.</span><span class=n>EINVAL</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>listen</span><span class=o>.</span><span class=n>stopped</span> <span class=o>=</span> <span class=bp>true</span> 
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>listen</span><span class=o>.</span><span class=n>Listener</span><span class=o>.</span><span class=n>Close</span><span class=p>()</span> <span class=o>//</span><span class=err>停止接受新的连接</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=n>get</span> <span class=n>fd</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>listen</span> <span class=o>*</span><span class=n>demoListener</span><span class=p>)</span> <span class=ne>File</span><span class=p>()</span> <span class=o>*</span><span class=n>os</span><span class=o>.</span><span class=n>File</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=n>returns</span> <span class=n>a</span> <span class=n>dup</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=n>FD_CLOEXEC</span> <span class=n>flag</span> <span class=o>*</span><span class=ow>not</span><span class=o>*</span> <span class=n>set</span>
</span></span><span class=line><span class=cl>	<span class=n>tcpListen</span> <span class=p>:</span><span class=o>=</span> <span class=n>listen</span><span class=o>.</span><span class=n>Listener</span><span class=o>.</span><span class=p>(</span><span class=o>*</span><span class=n>net</span><span class=o>.</span><span class=n>TCPListener</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>fd</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>tcpListen</span><span class=o>.</span><span class=n>File</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>fd</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>demoListener 定义的时候，通过匿名结构体（可以理解为是一种组合），继承了 net.Listener 的结构和方法，下面的 Accept 和 Close 则重载了 net.Listener 的 Accept 和 Close 方法。</p><p>Listener 在每个 Accept() 上都增加了一个等待组。</p><p>newDemoListener() 是 Listener 的构造函数。</p><p>File() 方法是从 Listener 中获取文件描述符 fd</p><p>当然，我们需要重载连接 net.Conn 的 Close() 方法，在连接断开时，将 wg 减一</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>type</span> <span class=n>demoConn</span> <span class=n>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>net</span><span class=o>.</span><span class=n>Conn</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>conn</span> <span class=n>demoConn</span><span class=p>)</span> <span class=n>Close</span><span class=p>()</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>Conn</span><span class=o>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>==</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>gWg</span><span class=o>.</span><span class=n>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，有可能客户端已经很长时间不发消息了，但是他不主动断开连接；为了避免这种情况，server 端通常认为这种是连接超时，在一定时间后会将连接关闭，故初始化 http.Server 时比较建议这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>	gServer = &amp;http.Server{
</span></span><span class=line><span class=cl>        Addr:           &#34;0.0.0.0:8086&#34;,
</span></span><span class=line><span class=cl>        ReadTimeout:    60 * time.Second,
</span></span><span class=line><span class=cl>        WriteTimeout:   60 * time.Second,
</span></span><span class=line><span class=cl>		MaxHeaderBytes: 1 &lt;&lt; 16,
</span></span><span class=line><span class=cl>		Handler:		demoHandler{},
</span></span><span class=line><span class=cl>	}
</span></span></code></pre></td></tr></table></div></div><blockquote><p><strong>注意：若使用的 go 版本在 1.8 版本以上（包括），http 包已经支持优雅退出，直接调用 Shutdown() 接口即可，更为简单。</strong></p></blockquote><p><strong>关闭 listener 连接和监控信号的部分这里便不再赘述，文末附有源码，有兴趣可以看看。</strong></p><p>测试结果：</p><p>启动 server，发送 http 请求</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5>5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6>6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>YOUSALI-MB0:~ yousa$ curl -i http://localhost:8086
</span></span><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Mon, 05 Nov 2018 08:11:17 GMT
</span></span><span class=line><span class=cl>Content-Length: 17
</span></span><span class=line><span class=cl>Content-Type: text/plain; charset=utf-8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Hello Tencent!
</span></span></code></pre></td></tr></table></div></div><p>发送 usr2 信号给 server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>YOUSALI-MB0:graceful-restart-demo yousa$ ps -ef | grep grace
</span></span><span class=line><span class=cl>  501 50199 41134   0  4:10 下午 ttys002    0:00.01 ./graceful-restart-demo
</span></span><span class=line><span class=cl>  501 50252 44808   0  4:11 下午 ttys003    0:00.00 grep grace
</span></span><span class=line><span class=cl>YOUSALI-MB0:graceful-restart-demo yousa$ kill -USR2 50199
</span></span><span class=line><span class=cl>YOUSALI-MB0:graceful-restart-demo yousa$ ps -ef | grep grace
</span></span><span class=line><span class=cl>  501 50253     1   0  4:11 下午 ttys002    0:00.01 /Users/yousa/work/src/graceful-restart-demo/graceful-restart-demo -graceful
</span></span><span class=line><span class=cl>  501 51460 44808   0  4:37 下午 ttys003    0:00.00 grep grace
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>## 终端打印
</span></span><span class=line><span class=cl>Hello World!
</span></span><span class=line><span class=cl>gracefulChild: false
</span></span><span class=line><span class=cl>2018/11/05 16:10:16 main: Listening on a new file descriptor.
</span></span><span class=line><span class=cl>2018/11/05 16:11:10 50199 Received SIGUSR2.
</span></span><span class=line><span class=cl>Hello World!
</span></span><span class=line><span class=cl>gracefulChild: true
</span></span><span class=line><span class=cl>2018/11/05 16:11:10 main: Listening to existing file descriptor 3.
</span></span><span class=line><span class=cl>2018/11/05 16:11:10 Graceful shutdown parent process.
</span></span><span class=line><span class=cl>2018/11/05 16:11:10 50199 Received SIGTERM.
</span></span></code></pre></td></tr></table></div></div><p>待升级后发送消息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4>4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5>5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6>6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>YOUSALI-MB0:~ yousa$ curl -i http://localhost:8086
</span></span><span class=line><span class=cl>HTTP/1.1 200 OK
</span></span><span class=line><span class=cl>Date: Mon, 05 Nov 2018 08:11:44 GMT
</span></span><span class=line><span class=cl>Content-Length: 14
</span></span><span class=line><span class=cl>Content-Type: text/plain; charset=utf-8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Happy 20th birthday!
</span></span></code></pre></td></tr></table></div></div><h3 id=遇到的问题>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题>#</a></h3><p>1、翻了下代码，并没有看到父进程如何退出？是怎样的流程？</p><p>先看一下 http ListenAndServe 接口，它会调用 net.Listen 和 serve.Serve 两个函数，net.Listen 是 listen 端口。</p><p>Serve 代码如下，它是一个 for 循环，Accept 一个新的连接后会用一个新的协程来处理请求；当 listen 的端口被关闭或者异常后，该 Serve 循环便会跳出</p><blockquote><p>另外，也可以在这里看到，如果让 http server 接入协程池则可以重载 http.Server 的 Serve，在收到新的连接后，从协程池中分配一个协程供新的连接使用。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1> 1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2> 2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3> 3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4> 4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5> 5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6> 6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7> 7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8> 8</a>
</span><span class=lnt id=hl-16-9><a class=lnlinks href=#hl-16-9> 9</a>
</span><span class=lnt id=hl-16-10><a class=lnlinks href=#hl-16-10>10</a>
</span><span class=lnt id=hl-16-11><a class=lnlinks href=#hl-16-11>11</a>
</span><span class=lnt id=hl-16-12><a class=lnlinks href=#hl-16-12>12</a>
</span><span class=lnt id=hl-16-13><a class=lnlinks href=#hl-16-13>13</a>
</span><span class=lnt id=hl-16-14><a class=lnlinks href=#hl-16-14>14</a>
</span><span class=lnt id=hl-16-15><a class=lnlinks href=#hl-16-15>15</a>
</span><span class=lnt id=hl-16-16><a class=lnlinks href=#hl-16-16>16</a>
</span><span class=lnt id=hl-16-17><a class=lnlinks href=#hl-16-17>17</a>
</span><span class=lnt id=hl-16-18><a class=lnlinks href=#hl-16-18>18</a>
</span><span class=lnt id=hl-16-19><a class=lnlinks href=#hl-16-19>19</a>
</span><span class=lnt id=hl-16-20><a class=lnlinks href=#hl-16-20>20</a>
</span><span class=lnt id=hl-16-21><a class=lnlinks href=#hl-16-21>21</a>
</span><span class=lnt id=hl-16-22><a class=lnlinks href=#hl-16-22>22</a>
</span><span class=lnt id=hl-16-23><a class=lnlinks href=#hl-16-23>23</a>
</span><span class=lnt id=hl-16-24><a class=lnlinks href=#hl-16-24>24</a>
</span><span class=lnt id=hl-16-25><a class=lnlinks href=#hl-16-25>25</a>
</span><span class=lnt id=hl-16-26><a class=lnlinks href=#hl-16-26>26</a>
</span><span class=lnt id=hl-16-27><a class=lnlinks href=#hl-16-27>27</a>
</span><span class=lnt id=hl-16-28><a class=lnlinks href=#hl-16-28>28</a>
</span><span class=lnt id=hl-16-29><a class=lnlinks href=#hl-16-29>29</a>
</span><span class=lnt id=hl-16-30><a class=lnlinks href=#hl-16-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>srv</span> <span class=o>*</span><span class=n>Server</span><span class=p>)</span> <span class=n>Serve</span><span class=p>(</span><span class=n>l</span> <span class=n>net</span><span class=o>.</span><span class=n>Listener</span><span class=p>)</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>defer</span> <span class=n>l</span><span class=o>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>tempDelay</span> <span class=n>time</span><span class=o>.</span><span class=n>Duration</span> <span class=o>//</span> <span class=n>how</span> <span class=n>long</span> <span class=n>to</span> <span class=n>sleep</span> <span class=n>on</span> <span class=n>accept</span> <span class=n>failure</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>rw</span><span class=p>,</span> <span class=n>e</span> <span class=p>:</span><span class=o>=</span> <span class=n>l</span><span class=o>.</span><span class=n>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>e</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=n>ne</span><span class=p>,</span> <span class=n>ok</span> <span class=p>:</span><span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=p>(</span><span class=n>net</span><span class=o>.</span><span class=n>Error</span><span class=p>);</span> <span class=n>ok</span> <span class=o>&amp;&amp;</span> <span class=n>ne</span><span class=o>.</span><span class=n>Temporary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=n>tempDelay</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>tempDelay</span> <span class=o>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Millisecond</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>tempDelay</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nb>max</span> <span class=p>:</span><span class=o>=</span> <span class=mi>1</span> <span class=o>*</span> <span class=n>time</span><span class=o>.</span><span class=n>Second</span><span class=p>;</span> <span class=n>tempDelay</span> <span class=o>&gt;</span> <span class=nb>max</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>tempDelay</span> <span class=o>=</span> <span class=nb>max</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>srv</span><span class=o>.</span><span class=n>logf</span><span class=p>(</span><span class=s2>&#34;http: Accept error: %v; retrying in %v&#34;</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>time</span><span class=o>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>tempDelay</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=n>c</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>srv</span><span class=o>.</span><span class=n>newConn</span><span class=p>(</span><span class=n>rw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>c</span><span class=o>.</span><span class=n>setState</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>rwc</span><span class=p>,</span> <span class=n>StateNew</span><span class=p>)</span> <span class=o>//</span> <span class=n>before</span> <span class=n>Serve</span> <span class=n>can</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=n>go</span> <span class=n>c</span><span class=o>.</span><span class=n>serve</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>再看一下 shutdownProcess 函数，故在这里关闭 listen socket 后，http Serve 处理请求的主循环便会退出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4>4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5>5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>shutdownProcess</span><span class=p>()</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>gServer</span><span class=o>.</span><span class=n>SetKeepAlivesEnabled</span><span class=p>(</span><span class=bp>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>gListen</span><span class=o>.</span><span class=n>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;shutdownProcess success.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>将 listen socket 关闭后，main 函数中的 gServer.Serve(gListen) 便会退出，但实际上已有的连接/服务并没有处理完成，需要使用 waitgroup 等待连接处理完成后，进程再退出。</p><h2 id=github-上的已有开源方案>github 上的已有开源方案<a hidden class=anchor aria-hidden=true href=#github-上的已有开源方案>#</a></h2><p>解决 golang http server 热更新问题，有了基本的思路之后，想到的是去 github 看下有没有稳定的解决方案。找到了如下三个库：</p><ul><li><a href=https://github.com/fvbock/endless>fvbock/endless</a> - Zero downtime restarts for golang HTTP and HTTPS servers. (for golang 1.3+)</li><li><a href=https://github.com/facebookgo/grace>facebookgo/grace</a> - Grace provides a library that makes it easy to build socket based servers that can be gracefully terminated & restarted (that is, without dropping any connections).</li><li><a href=https://github.com/jpillora/overseer>jpillora/overseer</a> - Overseer is a package for creating monitorable, gracefully restarting, self-upgrading binaries in Go (golang)</li></ul><blockquote><p>其实除了这些外，还有一些支持热更新的库，但是更新时间过老，在这里就不作讨论了。
当然，非常火爆的框架比如 beego 等，也支持热升级/gracefun shutdown，但是由于嵌入到了 beego 中，故本章中不作讨论，有兴趣的可以自行去看看。</p></blockquote><h3 id=实现浅析>实现浅析<a hidden class=anchor aria-hidden=true href=#实现浅析>#</a></h3><p>我们使用官方的例子来简单分析其流程并简单比较其异同</p><h4 id=1各个开源库-demo-代码>1、各个开源库 demo 代码<a hidden class=anchor aria-hidden=true href=#1各个开源库-demo-代码>#</a></h4><p>demo 代码较为冗长，很影响阅读观感，故贴在了最后的附录中</p><h4 id=2对比>2、对比<a hidden class=anchor aria-hidden=true href=#2对比>#</a></h4><p>操作步骤：</p><ul><li>编译 demo 示例，启动示例进程，记录其 pid</li><li>修改内容 (Hello Tencent 初始内容，修改为 Happy 20th Birthday！且请求处理均需要 sleep 10-20 秒），重新构建。</li><li>发送请求，发送热升级信号，再发送请求，对比两次请求内容</li><li>对比进程热升级前后的 pid，是否与之前一致</li></ul><p>结果对比</p><table><thead><tr><th>第三方库</th><th>第一次请求返回</th><th>第二次请求返回</th><th>操作前进程 pid</th><th>操作后进程 pid</th></tr></thead><tbody><tr><td>facebookgo/grace</td><td>Hello Tencent</td><td>Happy 20th Birthday！</td><td>41992</td><td>41998</td></tr><tr><td>fvbock/endless</td><td>Hello Tencent</td><td>Happy 20th Birthday！</td><td>41200</td><td>41520</td></tr><tr><td>jpillora/overseer</td><td>Hello Tencent</td><td>Happy 20th Birthday！</td><td>43424</td><td>43424</td></tr></tbody></table><p>原理浅析：</p><p>grace 和 endless 的热升级方法与本文重点讲述的方法一致，基本是 fork 一个子进程，子进程 listen 端口，父进程优雅退出，这里便不再赘述</p><blockquote><p>overseer 的热升级与 grace/endless 有些不同，由于作者很久不更新了（差不多 1-2 年），也找不到比较好的介绍文章，故这里只能简要贴一下其 github 上对 overseer 的原理介绍。由于不是本文核心介绍内容，放在附录中。
overseer 用一个主进程管理平滑重启，子进程处理连接，保持主进程 pid 不变；</p></blockquote><p>优缺点对比：</p><ul><li>grace 库支持 net tcp 热升级以及 http 热升级，endless 仅支持 http 热升级</li><li>grace 库接入第三方 http server 较麻烦（比如 fasthttp、gin 等）；endless 接入则只需要替换 ListenAndServe 即可（endless 继承/重写了 Serve 方法），通用性更好</li><li>grace 库功能强大，但是稍微复杂；endless 库更为简洁</li></ul><p>由于我的项目使用了 gin 作为 http 框架，故考虑到快速集成，我选择了 endless 该框架</p><blockquote><p>第三方库的对比经验：
主观因素：个人品味，是否要自己造轮子，朋友的推荐也对个人的判断也有很大影响；
客观因素：集成复杂度，内存管理，是否有大量 I/O 访问/耗性能访问，错误处理，工具参考文档等。</p></blockquote><p>集成起来也非常方便，类似于如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>router</span> <span class=p>:</span><span class=o>=</span> <span class=n>gin</span><span class=o>.</span><span class=n>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>router</span><span class=o>.</span><span class=n>GET</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=n>endless</span><span class=o>.</span><span class=n>ListenAndServe</span><span class=p>(</span><span class=s2>&#34;:8086&#34;</span><span class=p>,</span> <span class=n>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=问题拓展>问题拓展<a hidden class=anchor aria-hidden=true href=#问题拓展>#</a></h3><p>我其实又想了这些问题，也想抛出来与大家一起讨论</p><p>1、简单的 http server 很容易升级，若监听了多个端口该如何进行热升级？</p><p>2、若 go server 使用 tls 服务（其他也类似），如何进行升级？</p><p>3、go http server 在容器场景下是否需要平滑热升级？平滑停机是否足够？如果平滑停机足够的话，那么如何结合 docker+k8s 进行热升级？</p><p>个人猜测了一下，这种场景下，后端服务应该会有冗余部署，前端通过负载均衡/elb/tgw 等中间层访问，或者使用 consul 之类的服务注册发现机制，串行重启或者分批次重启，来做到不停服升级服务</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>热更新目标：</p><ul><li>1、正在处理中的连接/服务/请求不能立即中断，需要继续提供服务</li><li>2、socket 对用户来说要保持可用，可以接受新的请求</li></ul><p>直接沿用上篇的思路，热更新（单进程）流程，其基本流程如下：</p><ul><li>1、用新的 bin 文件去替换老的 bin 文件</li><li>2、发送信号告知 server 进程（通常是 USR2 信号），进行平滑升级</li><li>3、server 进程收到信号后，通过调用 fork/exec 启动新的版本的进程</li><li>4、子进程调用接口获取从父进程继承的 socket 文件描述符重新监听 socket</li><li>5、老的进程不再接受请求，待正在处理中的请求处理完后，进程自动退出</li><li>6、子进程托管给 init 进程</li></ul><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://grisha.org/blog/2014/06/03/graceful-restart-in-golang/>https://grisha.org/blog/2014/06/03/graceful-restart-in-golang/</a></li><li><a href=https://blog.csdn.net/u012058778/article/details/78705536>https://blog.csdn.net/u012058778/article/details/78705536</a></li><li><a href=http://gulu-dev.com/post/2014-07-28-tech-evaluation>http://gulu-dev.com/post/2014-07-28-tech-evaluation</a></li><li><a href=https://golang.org/doc/go1.8#http_shutdown>https://golang.org/doc/go1.8#http_shutdown</a> golang1.8 升级日志，支持 gracefulshutdown</li></ul><h2 id=代码附录>代码附录<a hidden class=anchor aria-hidden=true href=#代码附录>#</a></h2><h4 id=1facebookgograce>1、facebookgo/grace<a hidden class=anchor aria-hidden=true href=#1facebookgograce>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span><span class=lnt id=hl-19-17><a class=lnlinks href=#hl-19-17>17</a>
</span><span class=lnt id=hl-19-18><a class=lnlinks href=#hl-19-18>18</a>
</span><span class=lnt id=hl-19-19><a class=lnlinks href=#hl-19-19>19</a>
</span><span class=lnt id=hl-19-20><a class=lnlinks href=#hl-19-20>20</a>
</span><span class=lnt id=hl-19-21><a class=lnlinks href=#hl-19-21>21</a>
</span><span class=lnt id=hl-19-22><a class=lnlinks href=#hl-19-22>22</a>
</span><span class=lnt id=hl-19-23><a class=lnlinks href=#hl-19-23>23</a>
</span><span class=lnt id=hl-19-24><a class=lnlinks href=#hl-19-24>24</a>
</span><span class=lnt id=hl-19-25><a class=lnlinks href=#hl-19-25>25</a>
</span><span class=lnt id=hl-19-26><a class=lnlinks href=#hl-19-26>26</a>
</span><span class=lnt id=hl-19-27><a class=lnlinks href=#hl-19-27>27</a>
</span><span class=lnt id=hl-19-28><a class=lnlinks href=#hl-19-28>28</a>
</span><span class=lnt id=hl-19-29><a class=lnlinks href=#hl-19-29>29</a>
</span><span class=lnt id=hl-19-30><a class=lnlinks href=#hl-19-30>30</a>
</span><span class=lnt id=hl-19-31><a class=lnlinks href=#hl-19-31>31</a>
</span><span class=lnt id=hl-19-32><a class=lnlinks href=#hl-19-32>32</a>
</span><span class=lnt id=hl-19-33><a class=lnlinks href=#hl-19-33>33</a>
</span><span class=lnt id=hl-19-34><a class=lnlinks href=#hl-19-34>34</a>
</span><span class=lnt id=hl-19-35><a class=lnlinks href=#hl-19-35>35</a>
</span><span class=lnt id=hl-19-36><a class=lnlinks href=#hl-19-36>36</a>
</span><span class=lnt id=hl-19-37><a class=lnlinks href=#hl-19-37>37</a>
</span><span class=lnt id=hl-19-38><a class=lnlinks href=#hl-19-38>38</a>
</span><span class=lnt id=hl-19-39><a class=lnlinks href=#hl-19-39>39</a>
</span><span class=lnt id=hl-19-40><a class=lnlinks href=#hl-19-40>40</a>
</span><span class=lnt id=hl-19-41><a class=lnlinks href=#hl-19-41>41</a>
</span><span class=lnt id=hl-19-42><a class=lnlinks href=#hl-19-42>42</a>
</span><span class=lnt id=hl-19-43><a class=lnlinks href=#hl-19-43>43</a>
</span><span class=lnt id=hl-19-44><a class=lnlinks href=#hl-19-44>44</a>
</span><span class=lnt id=hl-19-45><a class=lnlinks href=#hl-19-45>45</a>
</span><span class=lnt id=hl-19-46><a class=lnlinks href=#hl-19-46>46</a>
</span><span class=lnt id=hl-19-47><a class=lnlinks href=#hl-19-47>47</a>
</span><span class=lnt id=hl-19-48><a class=lnlinks href=#hl-19-48>48</a>
</span><span class=lnt id=hl-19-49><a class=lnlinks href=#hl-19-49>49</a>
</span><span class=lnt id=hl-19-50><a class=lnlinks href=#hl-19-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>Command</span> <span class=n>gracedemo</span> <span class=n>implements</span> <span class=n>a</span> <span class=n>demo</span> <span class=n>server</span> <span class=n>showing</span> <span class=n>how</span> <span class=n>to</span> <span class=n>gracefully</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>terminate</span> <span class=n>an</span> <span class=n>HTTP</span> <span class=n>server</span> <span class=n>using</span> <span class=n>grace</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/facebookgo/grace/gracehttp&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>address0</span> <span class=o>=</span> <span class=n>flag</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=s2>&#34;a0&#34;</span><span class=p>,</span> <span class=s2>&#34;:48567&#34;</span><span class=p>,</span> <span class=s2>&#34;Zero address to bind to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>address1</span> <span class=o>=</span> <span class=n>flag</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=s2>&#34;a1&#34;</span><span class=p>,</span> <span class=s2>&#34;:48568&#34;</span><span class=p>,</span> <span class=s2>&#34;First address to bind to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>address2</span> <span class=o>=</span> <span class=n>flag</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=s2>&#34;a2&#34;</span><span class=p>,</span> <span class=s2>&#34;:48569&#34;</span><span class=p>,</span> <span class=s2>&#34;Second address to bind to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>now</span>      <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>flag</span><span class=o>.</span><span class=n>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>gracehttp</span><span class=o>.</span><span class=n>Serve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=n>http</span><span class=o>.</span><span class=n>Server</span><span class=p>{</span><span class=n>Addr</span><span class=p>:</span> <span class=o>*</span><span class=n>address0</span><span class=p>,</span> <span class=n>Handler</span><span class=p>:</span> <span class=n>newHandler</span><span class=p>(</span><span class=s2>&#34;Zero  &#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=n>http</span><span class=o>.</span><span class=n>Server</span><span class=p>{</span><span class=n>Addr</span><span class=p>:</span> <span class=o>*</span><span class=n>address1</span><span class=p>,</span> <span class=n>Handler</span><span class=p>:</span> <span class=n>newHandler</span><span class=p>(</span><span class=s2>&#34;First &#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=n>http</span><span class=o>.</span><span class=n>Server</span><span class=p>{</span><span class=n>Addr</span><span class=p>:</span> <span class=o>*</span><span class=n>address2</span><span class=p>,</span> <span class=n>Handler</span><span class=p>:</span> <span class=n>newHandler</span><span class=p>(</span><span class=s2>&#34;Second&#34;</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>newHandler</span><span class=p>(</span><span class=n>name</span> <span class=n>string</span><span class=p>)</span> <span class=n>http</span><span class=o>.</span><span class=n>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>mux</span> <span class=p>:</span><span class=o>=</span> <span class=n>http</span><span class=o>.</span><span class=n>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>mux</span><span class=o>.</span><span class=n>HandleFunc</span><span class=p>(</span><span class=s2>&#34;/sleep/&#34;</span><span class=p>,</span> <span class=k>func</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>duration</span><span class=p>,</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>ParseDuration</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>FormValue</span><span class=p>(</span><span class=s2>&#34;duration&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>http</span><span class=o>.</span><span class=n>Error</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=n>err</span><span class=o>.</span><span class=n>Error</span><span class=p>(),</span> <span class=mi>400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=n>time</span><span class=o>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fmt</span><span class=o>.</span><span class=n>Fprintf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>w</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=s2>&#34;</span><span class=si>%s</span><span class=s2> started at </span><span class=si>%s</span><span class=s2> slept for </span><span class=si>%d</span><span class=s2> nanoseconds from pid </span><span class=si>%d</span><span class=s2>.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>duration</span><span class=o>.</span><span class=n>Nanoseconds</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=n>os</span><span class=o>.</span><span class=n>Getpid</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>mux</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2fvbockendless>2、fvbock/endless<a hidden class=anchor aria-hidden=true href=#2fvbockendless>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1> 1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2> 2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3> 3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4> 4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5> 5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6> 6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7> 7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8> 8</a>
</span><span class=lnt id=hl-20-9><a class=lnlinks href=#hl-20-9> 9</a>
</span><span class=lnt id=hl-20-10><a class=lnlinks href=#hl-20-10>10</a>
</span><span class=lnt id=hl-20-11><a class=lnlinks href=#hl-20-11>11</a>
</span><span class=lnt id=hl-20-12><a class=lnlinks href=#hl-20-12>12</a>
</span><span class=lnt id=hl-20-13><a class=lnlinks href=#hl-20-13>13</a>
</span><span class=lnt id=hl-20-14><a class=lnlinks href=#hl-20-14>14</a>
</span><span class=lnt id=hl-20-15><a class=lnlinks href=#hl-20-15>15</a>
</span><span class=lnt id=hl-20-16><a class=lnlinks href=#hl-20-16>16</a>
</span><span class=lnt id=hl-20-17><a class=lnlinks href=#hl-20-17>17</a>
</span><span class=lnt id=hl-20-18><a class=lnlinks href=#hl-20-18>18</a>
</span><span class=lnt id=hl-20-19><a class=lnlinks href=#hl-20-19>19</a>
</span><span class=lnt id=hl-20-20><a class=lnlinks href=#hl-20-20>20</a>
</span><span class=lnt id=hl-20-21><a class=lnlinks href=#hl-20-21>21</a>
</span><span class=lnt id=hl-20-22><a class=lnlinks href=#hl-20-22>22</a>
</span><span class=lnt id=hl-20-23><a class=lnlinks href=#hl-20-23>23</a>
</span><span class=lnt id=hl-20-24><a class=lnlinks href=#hl-20-24>24</a>
</span><span class=lnt id=hl-20-25><a class=lnlinks href=#hl-20-25>25</a>
</span><span class=lnt id=hl-20-26><a class=lnlinks href=#hl-20-26>26</a>
</span><span class=lnt id=hl-20-27><a class=lnlinks href=#hl-20-27>27</a>
</span><span class=lnt id=hl-20-28><a class=lnlinks href=#hl-20-28>28</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/fvbock/endless&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>handler</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>w</span><span class=o>.</span><span class=n>Write</span><span class=p>([]</span><span class=n>byte</span><span class=p>(</span><span class=s2>&#34;WORLD!&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>mux1</span> <span class=p>:</span><span class=o>=</span> <span class=n>mux</span><span class=o>.</span><span class=n>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>mux1</span><span class=o>.</span><span class=n>HandleFunc</span><span class=p>(</span><span class=s2>&#34;/hello&#34;</span><span class=p>,</span> <span class=n>handler</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=n>Methods</span><span class=p>(</span><span class=s2>&#34;GET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>endless</span><span class=o>.</span><span class=n>ListenAndServe</span><span class=p>(</span><span class=s2>&#34;localhost:4242&#34;</span><span class=p>,</span> <span class=n>mux1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nb>log</span><span class=o>.</span><span class=n>Println</span><span class=p>(</span><span class=s2>&#34;Server on 4242 stopped&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>os</span><span class=o>.</span><span class=n>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3jpilloraoverseer>3、jpillora/overseer<a hidden class=anchor aria-hidden=true href=#3jpilloraoverseer>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1> 1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2> 2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3> 3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4> 4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5> 5</a>
</span><span class=lnt id=hl-21-6><a class=lnlinks href=#hl-21-6> 6</a>
</span><span class=lnt id=hl-21-7><a class=lnlinks href=#hl-21-7> 7</a>
</span><span class=lnt id=hl-21-8><a class=lnlinks href=#hl-21-8> 8</a>
</span><span class=lnt id=hl-21-9><a class=lnlinks href=#hl-21-9> 9</a>
</span><span class=lnt id=hl-21-10><a class=lnlinks href=#hl-21-10>10</a>
</span><span class=lnt id=hl-21-11><a class=lnlinks href=#hl-21-11>11</a>
</span><span class=lnt id=hl-21-12><a class=lnlinks href=#hl-21-12>12</a>
</span><span class=lnt id=hl-21-13><a class=lnlinks href=#hl-21-13>13</a>
</span><span class=lnt id=hl-21-14><a class=lnlinks href=#hl-21-14>14</a>
</span><span class=lnt id=hl-21-15><a class=lnlinks href=#hl-21-15>15</a>
</span><span class=lnt id=hl-21-16><a class=lnlinks href=#hl-21-16>16</a>
</span><span class=lnt id=hl-21-17><a class=lnlinks href=#hl-21-17>17</a>
</span><span class=lnt id=hl-21-18><a class=lnlinks href=#hl-21-18>18</a>
</span><span class=lnt id=hl-21-19><a class=lnlinks href=#hl-21-19>19</a>
</span><span class=lnt id=hl-21-20><a class=lnlinks href=#hl-21-20>20</a>
</span><span class=lnt id=hl-21-21><a class=lnlinks href=#hl-21-21>21</a>
</span><span class=lnt id=hl-21-22><a class=lnlinks href=#hl-21-22>22</a>
</span><span class=lnt id=hl-21-23><a class=lnlinks href=#hl-21-23>23</a>
</span><span class=lnt id=hl-21-24><a class=lnlinks href=#hl-21-24>24</a>
</span><span class=lnt id=hl-21-25><a class=lnlinks href=#hl-21-25>25</a>
</span><span class=lnt id=hl-21-26><a class=lnlinks href=#hl-21-26>26</a>
</span><span class=lnt id=hl-21-27><a class=lnlinks href=#hl-21-27>27</a>
</span><span class=lnt id=hl-21-28><a class=lnlinks href=#hl-21-28>28</a>
</span><span class=lnt id=hl-21-29><a class=lnlinks href=#hl-21-29>29</a>
</span><span class=lnt id=hl-21-30><a class=lnlinks href=#hl-21-30>30</a>
</span><span class=lnt id=hl-21-31><a class=lnlinks href=#hl-21-31>31</a>
</span><span class=lnt id=hl-21-32><a class=lnlinks href=#hl-21-32>32</a>
</span><span class=lnt id=hl-21-33><a class=lnlinks href=#hl-21-33>33</a>
</span><span class=lnt id=hl-21-34><a class=lnlinks href=#hl-21-34>34</a>
</span><span class=lnt id=hl-21-35><a class=lnlinks href=#hl-21-35>35</a>
</span><span class=lnt id=hl-21-36><a class=lnlinks href=#hl-21-36>36</a>
</span><span class=lnt id=hl-21-37><a class=lnlinks href=#hl-21-37>37</a>
</span><span class=lnt id=hl-21-38><a class=lnlinks href=#hl-21-38>38</a>
</span><span class=lnt id=hl-21-39><a class=lnlinks href=#hl-21-39>39</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>package</span> <span class=n>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/jpillora/overseer&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;github.com/jpillora/overseer/fetcher&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=n>see</span> <span class=n>example</span><span class=o>.</span><span class=n>sh</span> <span class=k>for</span> <span class=n>the</span> <span class=n>use</span><span class=o>-</span><span class=k>case</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>BuildID</span> <span class=n>is</span> <span class=n>compile</span><span class=o>-</span><span class=n>time</span> <span class=n>variable</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>BuildID</span> <span class=o>=</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=nb>convert</span> <span class=n>your</span> <span class=s1>&#39;main()&#39;</span> <span class=n>into</span> <span class=n>a</span> <span class=s1>&#39;prog(state)&#39;</span>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=s1>&#39;prog()&#39;</span> <span class=n>is</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>a</span> <span class=n>child</span> <span class=n>process</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>prog</span><span class=p>(</span><span class=n>state</span> <span class=n>overseer</span><span class=o>.</span><span class=n>State</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Printf</span><span class=p>(</span><span class=s2>&#34;app#</span><span class=si>%s</span><span class=s2> (</span><span class=si>%s</span><span class=s2>) listening...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>BuildID</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>http</span><span class=o>.</span><span class=n>Handle</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=n>http</span><span class=o>.</span><span class=n>HandlerFunc</span><span class=p>(</span><span class=k>func</span><span class=p>(</span><span class=n>w</span> <span class=n>http</span><span class=o>.</span><span class=n>ResponseWriter</span><span class=p>,</span> <span class=n>r</span> <span class=o>*</span><span class=n>http</span><span class=o>.</span><span class=n>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>d</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>ParseDuration</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>URL</span><span class=o>.</span><span class=n>Query</span><span class=p>()</span><span class=o>.</span><span class=n>Get</span><span class=p>(</span><span class=s2>&#34;d&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=n>time</span><span class=o>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>d</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>fmt</span><span class=o>.</span><span class=n>Fprintf</span><span class=p>(</span><span class=n>w</span><span class=p>,</span> <span class=s2>&#34;app#</span><span class=si>%s</span><span class=s2> (</span><span class=si>%s</span><span class=s2>) says hello</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>BuildID</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}))</span>
</span></span><span class=line><span class=cl>	<span class=n>http</span><span class=o>.</span><span class=n>Serve</span><span class=p>(</span><span class=n>state</span><span class=o>.</span><span class=n>Listener</span><span class=p>,</span> <span class=n>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>fmt</span><span class=o>.</span><span class=n>Printf</span><span class=p>(</span><span class=s2>&#34;app#</span><span class=si>%s</span><span class=s2> (</span><span class=si>%s</span><span class=s2>) exiting...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>BuildID</span><span class=p>,</span> <span class=n>state</span><span class=o>.</span><span class=n>ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=n>then</span> <span class=n>create</span> <span class=n>another</span> <span class=s1>&#39;main&#39;</span> <span class=n>which</span> <span class=n>runs</span> <span class=n>the</span> <span class=n>upgrades</span>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=s1>&#39;main()&#39;</span> <span class=n>is</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>initial</span> <span class=n>process</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>overseer</span><span class=o>.</span><span class=n>Run</span><span class=p>(</span><span class=n>overseer</span><span class=o>.</span><span class=n>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Program</span><span class=p>:</span> <span class=n>prog</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>Address</span><span class=p>:</span> <span class=s2>&#34;:5001&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>Fetcher</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>fetcher</span><span class=o>.</span><span class=n>File</span><span class=p>{</span><span class=ne>Path</span><span class=p>:</span> <span class=s2>&#34;my_app_next&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=n>Debug</span><span class=p>:</span>   <span class=bp>false</span><span class=p>,</span> <span class=o>//</span><span class=n>display</span> <span class=nb>log</span> <span class=n>of</span> <span class=n>overseer</span> <span class=n>actions</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=4overseer>4、overseer<a hidden class=anchor aria-hidden=true href=#4overseer>#</a></h4><ul><li><p>overseer uses the main process to check for and install upgrades and a child process to run Program.</p></li><li><p>The main process retrieves the files of the listeners described by Address/es.</p></li><li><p>The child process is provided with these files which is converted into a Listener/s for the Program to consume.</p></li><li><p>All child process pipes are connected back to the main process.</p></li><li><p>All signals received on the main process are forwarded through to the child process.</p></li><li><p>Fetcher runs in a goroutine and checks for updates at preconfigured interval. When Fetcher returns a valid binary stream (io.Reader), the master process saves it to a temporary location, verifies it, replaces the current binary and initiates a graceful restart.</p></li><li><p>The fetcher.HTTP accepts a URL, it polls this URL with HEAD requests and until it detects a change. On change, we GET the URL and stream it back out to overseer. See also fetcher.S3.</p></li><li><p>Once a binary is received, it is run with a simple echo token to confirm it is a overseer binary.</p></li><li><p>Except for scheduled restarts, the active child process exiting will cause the main process to exit with the same code. So, overseer is not a process manager.</p></li></ul><p>[外链图片转存失败，源站可能有防盗链机制，建议将图片保存下来直接上传 (img-nJwx0ZVC-1609089892264)(https://camo.githubusercontent.com/45df268c40025baddcafea70a437537c8c67b31c/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f316f31326e6a597952494c79335544733245364a7a794a456c3070735534655059694d5132306a6975564f592f7075623f773d35363626683d323834)]</p><h2 id=参考-1>参考<a hidden class=anchor aria-hidden=true href=#参考-1>#</a></h2><p><a href=http://tengine.taobao.org/nginx_docs/cn/docs/control.html>http://tengine.taobao.org/nginx_docs/cn/docs/control.html</a></p><h2 id=附加技巧>附加技巧<a hidden class=anchor aria-hidden=true href=#附加技巧>#</a></h2><blockquote><p>nginx 如何在指定时间内热重启？</p></blockquote><blockquote><p>envoy 热重启流程跟一般golang进程、nginx进程又有什么异同？</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://miss-you.github.io/tags/nginx/>Nginx</a></li><li><a href=https://miss-you.github.io/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://miss-you.github.io/posts/history-of-western-painting/><span class=title>« Prev</span><br><span>《欧洲绘画五百年》参观有感</span>
</a><a class=next href=https://miss-you.github.io/posts/how-to-get-localip/><span class=title>Next »</span><br><span>获取服务器本机 IP 的不同语言实现</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on x" href="https://x.com/intent/tweet/?text=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0&amp;url=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f&amp;hashtags=nginx%2cgolang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f&amp;title=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0&amp;summary=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0&amp;source=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f&title=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on whatsapp" href="https://api.whatsapp.com/send?text=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0%20-%20https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on telegram" href="https://telegram.me/share/url?text=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0&amp;url=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 从 nginx 热更新聊一聊 Golang 中的热更新 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%e4%bb%8e%20nginx%20%e7%83%ad%e6%9b%b4%e6%96%b0%e8%81%8a%e4%b8%80%e8%81%8a%20Golang%20%e4%b8%ad%e7%9a%84%e7%83%ad%e6%9b%b4%e6%96%b0&u=https%3a%2f%2fmiss-you.github.io%2fposts%2fserver-hot-update%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://miss-you.github.io/>Yousa Driven Development | YDD</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>